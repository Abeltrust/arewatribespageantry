<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Live Voting Results — Amber Showcase</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --bg: #fff7ed;
    --card: #ffffff;
    --muted: #333333;
    --accent: #ffb300; /* amber */
    --accent-600: #ff9800;
    --accent-700: #ef6c00;
    --good: #16a34a;
    --bad: #e02424;
    --glass: rgba(255,255,255,0.6);
    --shadow: 0 10px 30px rgba(15,15,15,0.08);
    --radius: 12px;
  }
  *{box-sizing:border-box}
  body{background:var(--bg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:var(--muted);margin:0;padding:18px;line-height:1.35}
  .wrap{max-width:1100px;margin:0 auto}

  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-700));display:grid;place-items:center;color:white;font-weight:800;font-size:20px}
  h1{margin:0;font-size:18px}
  .subtitle{color:#6b5a4a;font-size:13px}

  /* HERO TOP 5 */
  .hero{display:grid;grid-template-columns:1.45fr 1fr;gap:16px;margin-bottom:18px}
  @media(max-width:900px){ .hero{grid-template-columns:1fr;}}
  .topArea{background:var(--card);padding:16px;border-radius:var(--radius);box-shadow:var(--shadow)}
  .topGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .firstCard{display:flex;gap:12px;padding:14px;border-radius:10px;background:linear-gradient(90deg,rgba(255,179,0,0.12),transparent);align-items:center}
  .firstCard img{width:160px;height:160px;object-fit:cover;border-radius:10px;flex-shrink:0}
  .firstInfo{flex:1}
  .pos{font-size:28px;font-weight:900;color:var(--accent-700)}
  .name{font-size:20px;font-weight:800;margin-top:6px}
  .score{font-size:32px;font-weight:900;color:var(--accent);margin-top:6px}

  .sideCards{display:grid;grid-template-rows:1fr 1fr;gap:12px}
  .medCard{display:flex;gap:10px;align-items:center;padding:12px;border-radius:10px;background:#fff8ea}
  .medCard img{width:72px;height:72px;border-radius:8px;object-fit:cover}

  .bottomCards{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:12px}
  .smallCard{display:flex;gap:10px;align-items:center;padding:10px;border-radius:10px;background:linear-gradient(90deg,rgba(255,235,205,0.6),transparent)}

  /* CHART + controls */
  .panel{background:var(--card);padding:14px;border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:18px}
  .controls{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .controls-left{display:flex;gap:8px;align-items:center}
  .btn{padding:8px 12px;border-radius:8px;background:var(--accent);color:white;border:none;cursor:pointer;font-weight:700}
  .muted{color:#6b6b6b;font-size:13px}

  /* TABLE & CARDS LIST */
  .table-wrapper{overflow-x:auto}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #f0e6d5;text-align:left;vertical-align:middle}
  th{font-size:13px;color:#4b3a2a;background:rgba(0,0,0,0.03)}
  .thumb{width:48px;height:48px;border-radius:8px;object-fit:cover}
  .progressWrap{height:10px;background:#fff1de;border-radius:999px;overflow:hidden;margin-top:6px}
  .progress{height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent-700));transition:width .8s ease}

  /* mobile card list */
  #cardsList{display:none;margin-top:12px;gap:8px}
  .cardItem{display:flex;gap:12px;align-items:center;padding:10px;border-radius:10px;background:var(--card);box-shadow:0 6px 18px rgba(0,0,0,0.04)}
  .cardItem img{width:72px;height:72px;object-fit:cover;border-radius:8px}

  /* responsive */
  @media (max-width:900px){
    .table-wrapper{display:none}
    #cardsList{display:block}
    .bottomCards{grid-template-columns:1fr 1fr}
    .firstCard img{width:120px;height:120px}
    .firstCard{padding:12px}
  }

  footer{margin-top:20px;text-align:center;color:#7b6d60;font-size:13px}

  /* admin trigger small invisible area */
  #adminTrigger{position:fixed;left:10px;bottom:10px;width:36px;height:36px;opacity:0;z-index:9999}

  /* login overlay */
  #loginOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(10,10,10,0.5);z-index:9999}
  .loginBox{background:var(--card);padding:18px;border-radius:12px;width:320px;box-shadow:var(--shadow)}
  input[type="password"], input[type="datetime-local"]{width:100%;padding:10px;border-radius:8px;border:1px solid #eee;margin-top:8px}

  /* small helpers */
  .small{font-size:13px;color:#5b4a3f}
  .about{font-size:13px;color:#6b5543;margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo">A</div>
      <div>
        <h1>Amber Results — Live Showcase</h1>
        <div class="subtitle">Top contestants, live chart & full leaderboard</div>
      </div>
    </div>
    <div class="small muted">Auto-refresh from server • Admin-protected</div>
  </header>

  <!-- HERO TOP-5 -->
  <div class="hero">
    <div class="topArea">
      <div class="firstCard" id="firstCard">
        <img src="" alt="First" id="firstImg">
        <div class="firstInfo">
          <div class="pos" id="firstPos">#1</div>
          <div class="name" id="firstName">Loading...</div>
          <div class="about" id="firstAbout">—</div>
          <div class="score" id="firstScore">0</div>
        </div>
      </div>

      <div class="bottomCards">
        <div class="smallCard medCard" id="secondCard">
          <img src="" id="secondImg" alt="2nd">
          <div>
            <div style="font-weight:800" id="secondName">—</div>
            <div class="small" id="secondScore">0 votes</div>
          </div>
        </div>

        <div class="smallCard medCard" id="thirdCard">
          <img src="" id="thirdImg" alt="3rd">
          <div>
            <div style="font-weight:800" id="thirdName">—</div>
            <div class="small" id="thirdScore">0 votes</div>
          </div>
        </div>

        <div class="smallCard" id="fourthCard" style="margin-top:6px">
          <img src="" id="fourthImg" alt="4th">
          <div>
            <div style="font-weight:800" id="fourthName">—</div>
            <div class="small" id="fourthScore">0 votes</div>
          </div>
        </div>

        <div class="smallCard" id="fifthCard" style="margin-top:6px">
          <img src="" id="fifthImg" alt="5th">
          <div>
            <div style="font-weight:800" id="fifthName">—</div>
            <div class="small" id="fifthScore">0 votes</div>
          </div>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="controls">
        <div class="controls-left">
          <div class="muted">Live Chart</div>
        </div>
        <div>
          <button class="btn" id="downloadCSVBtn">Prepare CSV for Download</button>
        </div>
      </div>

      <canvas id="resultsChart" aria-label="Results chart"></canvas>
    </div>
  </div>

  <!-- SEARCH -->
  <div style="display:flex;justify-content:flex-end;margin-bottom:8px;gap:8px;align-items:center">
    <input id="search" placeholder="Search contestants..." style="padding:8px;border-radius:8px;border:1px solid #e9dcc9;width:260px" />
  </div>

  <!-- LEADERBOARD -->
  <div class="panel table-wrapper">
    <table id="resultsTable" aria-live="polite">
      <thead>
        <tr><th style="width:64px">#</th><th>Contestant</th><th style="width:78px">Image</th><th style="width:110px">Votes</th><th style="width:220px">Progress</th></tr>
      </thead>
      <tbody id="resultsBody"><tr><td colspan="5" style="text-align:center;padding:16px">Loading...</td></tr></tbody>
    </table>
  </div>

  <!-- MOBILE CARDS -->
  <div id="cardsList"></div>

  <!-- ADMIN TRIGGER (invisible square) -->
  <div id="adminTrigger" title="Admin"></div>

  <!-- LOGIN OVERLAY -->
  <div id="loginOverlay">
    <div class="loginBox">
      <h3 style="margin:0 0 8px 0;color:var(--accent)">Admin Login</h3>
      <div class="small muted">Enter PIN to unlock admin controls</div>
      <input id="adminPin" type="password" placeholder="Admin PIN" />
      <div style="display:flex;gap:8px;margin-top:10px;justify-content:flex-end">
        <button class="btn" id="loginBtn">Unlock</button>
      </div>
      <div id="loginMsg" class="small" style="margin-top:8px;color:var(--bad);display:none"></div>
    </div>
  </div>

  <!-- ADMIN PANEL (appears after unlock) -->
  <div id="adminPanel" class="panel" style="display:none;margin-top:12px">
    <h3 style="margin:0 0 12px 0">Admin Control</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <label class="small">Upload CSV (preview only)</label>
      <input id="csvUpload" type="file" accept=".csv" />
      <button class="btn" id="uploadBtn" style="background:var(--accent)">Upload & Preview</button>

      <label class="small" style="margin-left:8px">Countdown</label>
      <input id="closeAt" type="datetime-local" />

      <button class="btn" id="setClose" style="background:var(--accent-700)">Set Close</button>
      <button class="btn" id="logoutBtn" style="background:#b55200">Logout</button>
      <button class="btn" id="clearPreview" style="background:#9e9e9e">Clear Preview</button>
    </div>
    <div class="small" style="margin-top:10px;color:#6b5543">To persist changes live, replace the server <code>results.csv</code> with the downloaded CSV (use Prepare CSV for Download button).</div>
  </div>

  <footer>Made with culture • Keep your admin PIN safe</footer>
</div>

<script>
/* ==================================================
   CONFIG & STATE
   - CSV format: ID,Name,Score,Image,About
   - Place results.csv on the same folder as this file
   - Admin PIN: change before publishing
   ================================================== */
const CSV_PATH = 'results.csv';
const ADMIN_PIN_DEFAULT = '4321'; // change this before publish
let ADMIN_PIN = ADMIN_PIN_DEFAULT;
let isAuthed = false;
let csvTextCache = null;
let dataRows = [];
let chart = null;
let countdownAt = localStorage.getItem('countdownAt') || null;
let refreshSeconds = Number(localStorage.getItem('refreshSeconds') || 10);
let tries = Number(localStorage.getItem('tries') || 0);
let lockUntil = Number(localStorage.getItem('lockUntil') || 0);

/* =============== UTIL: robust CSV parser (handles quotes) =============== */
function parseCSVText(text){
  if(!text) return [];
  const rows = [];
  let cur = '', row = [], inQuotes=false;
  for(let i=0;i<text.length;i++){
    const ch = text[i], nxt = text[i+1];
    if(ch === '"'){
      if(inQuotes && nxt === '"'){ cur += '"'; i++; continue; }
      inQuotes = !inQuotes;
      continue;
    }
    if(ch === ',' && !inQuotes){ row.push(cur); cur=''; continue; }
    if((ch === '\n' || ch === '\r') && !inQuotes){
      if(cur !== '' || row.length>0){ row.push(cur); rows.push(row); row=[]; cur=''; }
      if(ch === '\r' && text[i+1] === '\n'){ i++; }
      continue;
    }
    cur += ch;
  }
  if(cur !== '' || row.length>0){ row.push(cur); rows.push(row); }
  return rows.filter(r=>r.length>0);
}

/* =============== LOAD CSV from server (auto-refresh) =============== */
async function loadCSVFromServer(){
  try{
    const res = await fetch(CSV_PATH + '?t=' + Date.now());
    if(!res.ok) throw new Error('HTTP ' + res.status);
    const txt = await res.text();
    csvTextCache = txt;
    localStorage.setItem('lastServerCSV', txt);
    processCSV(txt);
  }catch(err){
    const fallback = localStorage.getItem('previewCSV') || localStorage.getItem('lastServerCSV');
    if(fallback) processCSV(fallback);
    else {
      document.getElementById('resultsBody').innerHTML = '<tr><td colspan="5" style="text-align:center;padding:16px">Unable to load CSV — ensure results.csv is on server.</td></tr>';
    }
    console.error('CSV load failed', err);
  }
}

/* =============== PROCESS CSV into dataRows =============== */
function processCSV(txt){
  if(!txt){ return; }
  const table = parseCSVText(String(txt).trim());
  if(table.length < 1) return;
  const headers = table[0].map(h => h.trim());
  const rows = table.slice(1).map((r,i)=>{
    const obj = {};
    headers.forEach((hh, idx)=> obj[hh || ('col'+idx)] = (r[idx] ?? '').trim());
    // normalize fields
    return {
      ID: obj.ID || String(i+1),
      Name: obj.Name || obj.name || obj.FullName || ('Candidate ' + (i+1)),
      Score: Number(String(obj.Score || obj.Votes || obj.Score || 0).replace(/[^0-9.\-]/g,'')) || 0,
      Image: obj.Image || obj.image || obj.Photo || '',
      About: obj.About || obj.Description || ''
    };
  });

  // sort descending by Score
  rows.sort((a,b)=> b.Score - a.Score);
  dataRows = rows;
  renderAll();
}

/* =============== RENDER: top5 hero, table, cards, chart =============== */
function renderAll(){
  renderTop5();
  renderTable();
  renderCards();
  renderChart();
  document.getElementById('downloadCSVBtn').disabled = !csvTextCache;
  // update updatedAt
  // animate progress bars
  setTimeout(()=> {
    document.querySelectorAll('.progress').forEach(el=>{
      const p = el.getAttribute('data-percent') || '0';
      el.style.width = Math.min(100, Math.max(0, Number(p))) + '%';
    });
  },80);
}

function renderTop5(){
  const top = dataRows.slice(0,5);
  // defaults
  const first = top[0] || {Name:'—',Score:0,Image:'',About:''};
  document.getElementById('firstImg').src = first.Image || blankImage();
  document.getElementById('firstPos').innerText = '#1';
  document.getElementById('firstName').innerText = first.Name;
  document.getElementById('firstAbout').innerText = first.About || '';
  document.getElementById('firstScore').innerText = first.Score;

  const s2 = top[1] || {Name:'—',Score:0,Image:''};
  const s3 = top[2] || {Name:'—',Score:0,Image:''};
  const s4 = top[3] || {Name:'—',Score:0,Image:''};
  const s5 = top[4] || {Name:'—',Score:0,Image:''};

  document.getElementById('secondImg').src = s2.Image || blankImage();
  document.getElementById('secondName').innerText = s2.Name;
  document.getElementById('secondScore').innerText = s2.Score + ' votes';

  document.getElementById('thirdImg').src = s3.Image || blankImage();
  document.getElementById('thirdName').innerText = s3.Name;
  document.getElementById('thirdScore').innerText = s3.Score + ' votes';

  document.getElementById('fourthImg').src = s4.Image || blankImage();
  document.getElementById('fourthName').innerText = s4.Name;
  document.getElementById('fourthScore').innerText = s4.Score + ' votes';

  document.getElementById('fifthImg').src = s5.Image || blankImage();
  document.getElementById('fifthName').innerText = s5.Name;
  document.getElementById('fifthScore').innerText = s5.Score + ' votes';
}

function renderTable(){
  const tbody = document.getElementById('resultsBody');
  if(!dataRows || dataRows.length === 0){
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:16px">No results</td></tr>';
    return;
  }
  const total = dataRows.reduce((s,r)=> s + (r.Score || 0), 0) || 1;
  tbody.innerHTML = '';
  dataRows.forEach((r, idx)=>{
    const pct = Math.round((r.Score / total) * 100);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="font-weight:800">${idx+1}</td>
                    <td>
                      <div style="font-weight:800">${escapeHtml(r.Name)}</div>
                      <div class="small about">${escapeHtml(r.About)}</div>
                    </td>
                    <td><img src="${r.Image || blankImage()}" class="thumb" alt=""></td>
                    <td style="font-weight:900">${r.Score}</td>
                    <td>
                      <div class="progressWrap"><div class="progress" data-percent="${pct}"></div></div>
                      <div class="small" style="margin-top:6px">${pct}%</div>
                    </td>`;
    tbody.appendChild(tr);
  });
}

function renderCards(){
  const list = document.getElementById('cardsList');
  list.innerHTML = '';
  const total = dataRows.reduce((s,r)=> s + (r.Score || 0), 0) || 1;
  dataRows.forEach((r, idx)=>{
    const pct = Math.round((r.Score / total) * 100);
    const div = document.createElement('div');
    div.className = 'cardItem';
    div.innerHTML = `<img src="${r.Image || blankImage()}" alt="">
                     <div style="flex:1">
                       <div style="display:flex;justify-content:space-between;align-items:center">
                        <div style="font-weight:800">${escapeHtml(r.Name)}</div>
                        <div style="font-weight:900;color:var(--accent)">${r.Score}</div>
                       </div>
                       <div class="small about">${escapeHtml(r.About)}</div>
                       <div class="progressWrap" style="margin-top:8px"><div class="progress" data-percent="${pct}"></div></div>
                     </div>`;
    list.appendChild(div);
  });
}

/* Chart */
function renderChart(){
  const ctx = document.getElementById('resultsChart').getContext('2d');
  const labels = dataRows.map(r => r.Name);
  const values = dataRows.map(r => r.Score);
  const colors = dataRows.map((_,i)=> i===0 ? '#ffcc66' : i===1 ? '#ffd88a' : i===2 ? '#ffdd99' : '#ffb300');

  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Votes', data: values, backgroundColor: colors }] },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true } }
    }
  });
}

/* =============== HELPERS =============== */
function blankImage(){
  // tiny transparent amber placeholder (data URI)
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'><rect rx='12' width='100%' height='100%' fill='%23ffecd1'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='%23b56a00' font-size='20'>No Image</text></svg>`);
}
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* =============== SEARCH FILTER =============== */
document.getElementById('search').addEventListener('input', function(){
  const q = this.value.trim().toLowerCase();
  if(!q){ renderAll(); return; }
  const filtered = dataRows.filter(r => (r.Name || '').toLowerCase().includes(q) || (r.About||'').toLowerCase().includes(q));
  // render filtered views
  // temporarily set displayed data
  renderFiltered(filtered);
});

function renderFiltered(rows){
  // top5 uses the filtered first 5
  const prevData = dataRows;
  dataRows = rows;
  renderTop5();
  renderTable();
  renderCards();
  renderChart();
  dataRows = prevData; // restore
}

/* =============== ADMIN: PIN + Brute-force limit =============== */
const adminTrigger = document.getElementById('adminTrigger');
const loginOverlay = document.getElementById('loginOverlay');
const loginBtn = document.getElementById('loginBtn');
const adminPinInput = document.getElementById('adminPin');
const loginMsg = document.getElementById('loginMsg');
const adminPanel = document.getElementById('adminPanel');

adminTrigger.addEventListener('click', ()=> {
  if(isLocked()){
    alert('Admin locked. Try later.');
    return;
  }
  loginOverlay.style.display = 'flex';
  adminPinInput.value = '';
  adminPinInput.focus();
});

function isLocked(){
  return Date.now() < lockUntil;
}

loginBtn.addEventListener('click', ()=> {
  const pin = adminPinInput.value.trim();
  // check local stored override PIN (optional)
  const stored = localStorage.getItem('adminPinHash');
  if(stored){
    // compare SHA-256
    sha256(pin).then(h=>{
      if(h === stored){ succeedLogin(); }
      else failLogin();
    });
  } else {
    if(pin === ADMIN_PIN){ succeedLogin(); }
    else failLogin();
  }
});

function succeedLogin(){
  isAuthed = true;
  loginOverlay.style.display = 'none';
  adminPanel.style.display = 'block';
  loginMsg.style.display = 'none';
  tries = 0; localStorage.setItem('tries', 0);
  alert('Admin unlocked for this session.');
}
function failLogin(){
  tries++;
  localStorage.setItem('tries', tries);
  loginMsg.style.display = 'block';
  loginMsg.innerText = 'Incorrect PIN';
  if(tries >= 4){
    lockUntil = Date.now() + 5*60*1000; // 5 minutes
    localStorage.setItem('lockUntil', lockUntil);
    loginMsg.innerText = 'Too many attempts — locked for 5 minutes';
    setTimeout(()=> loginOverlay.style.display = 'none', 800);
  }
}

document.getElementById('logoutBtn').addEventListener('click', ()=> {
  isAuthed = false;
  adminPanel.style.display = 'none';
  alert('Logged out');
});

/* optional hashing helper */
async function sha256(str){
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

/* =============== ADMIN: Upload & Prepare CSV download =============== */
document.getElementById('uploadBtn').addEventListener('click', ()=> {
  if(!isAuthed){ alert('Unlock admin first'); return; }
  const f = document.getElementById('csvUpload').files[0];
  if(!f) return alert('Pick a CSV file');
  const reader = new FileReader();
  reader.onload = e => {
    const txt = e.target.result;
    localStorage.setItem('previewCSV', txt);
    csvTextCache = txt;
    processCSV(txt);
    alert('Preview saved locally. Use "Prepare CSV for Download" to replace server file.');
  };
  reader.readAsText(f);
});

document.getElementById('downloadCSVBtn').addEventListener('click', ()=> {
  const csv = csvTextCache || localStorage.getItem('previewCSV') || localStorage.getItem('lastServerCSV');
  if(!csv) return alert('No CSV loaded yet');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'results.csv'; a.click();
});

document.getElementById('clearPreview').addEventListener('click', ()=> {
  if(!isAuthed){ alert('Unlock admin first'); return; }
  if(confirm('Clear local preview and countdown?')){
    localStorage.removeItem('previewCSV');
    localStorage.removeItem('countdownAt');
    localStorage.removeItem('lastServerCSV');
    csvTextCache = null;
    loadCSVFromServer();
  }
});

document.getElementById('setClose').addEventListener('click', ()=> {
  if(!isAuthed){ alert('Unlock admin first'); return; }
  const v = document.getElementById('closeAt').value;
  if(!v) return alert('Pick a date & time');
  countdownAt = new Date(v).toISOString();
  localStorage.setItem('countdownAt', countdownAt);
  alert('Countdown saved to browser. To publish globally, update server-side config.');
});

/* countdown updater */
setInterval(()=> {
  if(countdownAt) {
    const then = new Date(countdownAt);
    const now = new Date();
    const diff = then - now;
    const el = document.getElementById('countdown');
    if(diff <= 0) el.innerText = 'Voting closed';
    else {
      const d = Math.floor(diff/(1000*60*60*24));
      const h = Math.floor((diff%(1000*60*60*24))/(1000*60*60));
      const m = Math.floor((diff%(1000*60*60))/(1000*60));
      const s = Math.floor((diff%(1000*60))/1000);
      el.innerText = `Ends in: ${d}d ${h}h ${m}m ${s}s`;
    }
  }
}, 1000);

/* =============== AUTO REFRESH =============== */
setInterval(()=> {
  loadCSVFromServer();
}, Math.max(3000, refreshSeconds*1000));

/* =============== INIT =============== */
(function init(){
  // restore saved preview if exists or load server csv
  const preview = localStorage.getItem('previewCSV');
  if(preview){ csvTextCache = preview; processCSV(preview); } else loadCSVFromServer();

  // restore countdown
  if(localStorage.getItem('countdownAt')) {
    countdownAt = localStorage.getItem('countdownAt');
    document.getElementById('closeAt').value = new Date(countdownAt).toISOString().slice(0,16);
  }

  // restore refreshSeconds
  const saved = Number(localStorage.getItem('refreshSeconds'));
  if(saved) refreshSeconds = saved;

  // restore admin lock state
  const lu = Number(localStorage.getItem('lockUntil') || 0);
  if(lu) lockUntil = lu;
})();

</script>
</body>
</html>
