<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Live Voting Dashboard — Amber Showcase</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --bg: #fff8f1;
    --card: #ffffff;
    --muted: #4b3a2a;
    --accent: #ffb300; /* amber */
    --accent-600: #ff9800;
    --accent-700: #ef6c00;
    --accent-900: #b56a00;
    --glass: rgba(255,255,255,0.8);
    --shadow: 0 14px 40px rgba(11,10,10,0.08);
    --radius: 14px;
  }

  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Arial,Helvetica;background:var(--bg);color:var(--muted);-webkit-font-smoothing:antialiased;line-height:1.4}
  .wrap{max-width:1200px;margin:24px auto;padding:20px}

  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-700));display:grid;place-items:center;color:white;font-weight:900;font-size:22px}
  h1{margin:0;font-size:20px}
  .subtitle{color:#6b513a;font-size:13px}

  /* Dashboard grid (desktop-first) */
  .dashboard { display: grid; grid-template-columns: 1fr 420px; gap:18px; align-items:start; }

  /* LEFT: top 1 + chart */
  .leftCol { display: flex; flex-direction: column; gap:18px; }

  .topHero {
    background: linear-gradient(180deg, rgba(255,242,224,0.6), rgba(255,247,238,0.6));
    border-radius: var(--radius);
    padding: 18px;
    box-shadow: var(--shadow);
    display: grid;
    grid-template-columns: 380px 1fr;
    gap: 18px;
    align-items: center;
  }

  .topHero .firstImg {
    width: 320px;
    height: 320px;
    border-radius: 12px;
    object-fit: cover;
    box-shadow: 0 10px 30px rgba(0,0,0,0.06);
    background: #fff4e6;
  }
  .topHero .firstInfo { padding-right:8px; }
  .topHero .pos { font-size:26px;font-weight:900;color:var(--accent-700) }
  .topHero .name { font-size:28px;font-weight:900;margin-top:6px; font-family: "Merriweather", serif; }
  .topHero .about { margin-top:8px;color:#6b513a }
  .topHero .score { margin-top:12px;font-size:28px;font-weight:900;color:var(--accent) }

  /* RIGHT: Top 2-5 */
  .rightCol { display:flex;flex-direction:column; gap:18px; }
  .topList { background:var(--card);padding:14px;border-radius:var(--radius);box-shadow:var(--shadow); }
  .topList .grid2 { display:grid; grid-template-columns: 1fr; gap:12px; }
  /* for desktop show 2x2 in right column (2 rows) */
  .topList .item {
    display:flex;gap:12px;align-items:center;padding:10px;border-radius:10px;background:#fff8ea;
  }
  .topList .item img { width:120px;height:120px;object-fit:cover;border-radius:10px;flex-shrink:0; }
  .topList .item .meta { flex:1 }
  .topList .item .meta .rank { font-weight:900;color:var(--accent-700) }
  .topList .item .meta .name { font-weight:800;margin-top:6px }
  .topList .item .meta .votes { margin-top:8px;font-weight:900;color:var(--accent) }

  /* Photo gallery above results (vote buttons) */
  .voteGallery { display:flex; gap:12px; flex-wrap:wrap; margin: 12px 0; }
  .voteCard { width:160px; background:var(--card); border-radius:12px; padding:8px; box-shadow:0 8px 20px rgba(0,0,0,0.06); text-align:center; }
  .voteCard img{ width:140px; height:140px; object-fit:cover; border-radius:10px; display:block; margin:0 auto 8px; }
  .voteCard .vname{ font-weight:800; font-size:14px; margin-bottom:6px; color:var(--muted) }
  .voteCard .vtribe{ font-size:12px;color:#6b513a;margin-bottom:8px }
  .voteBtn { display:inline-block; padding:8px 10px; border-radius:8px; background:var(--accent); color:#2b1600; font-weight:800; text-decoration:none; box-shadow:0 8px 20px rgba(181,106,0,0.12); }

  /* Chart & controls */
  .panel{background:var(--card);padding:14px;border-radius:var(--radius);box-shadow:var(--shadow)}
  .controls{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:12px}
  .search{padding:8px;border-radius:10px;border:1px solid #efe1cb;min-width:220px}

  canvas{width:100%!important;height:340px!important}

  /* Leaderboard table */
  .table-wrapper{overflow-x:auto}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:12px;border-bottom:1px solid #fbefe0;vertical-align:middle}
  th{color:#6b513a;text-transform:uppercase;font-size:12px}
  .thumb{width:64px;height:64px;border-radius:8px;object-fit:cover}

  .progressWrap { height:12px; background:#fff1de; border-radius:999px; overflow:hidden; margin-top:6px; }
  .progress { height:100%; width:0; background: linear-gradient(90deg,var(--accent),var(--accent-700)); transition: width .8s ease; }

  /* Mobile cards list */
  #cardsList{display:none;margin-top:12px; gap:10px}
  .cardItem{display:flex;gap:12px;align-items:center;padding:12px;border-radius:12px;background:var(--card);box-shadow:0 8px 20px rgba(181,106,0,0.06)}
  .cardItem img{width:84px;height:84px;object-fit:cover;border-radius:8px}

  /* Footer */
  footer{margin-top:22px;text-align:center;color:#6b513a;font-size:13px}

  /* Responsive adjustments (mobile) */
  @media (max-width: 980px){
    .dashboard { grid-template-columns: 1fr; }
    .topHero { grid-template-columns: 1fr; }
    .topHero .firstImg { width:100%; height:260px; }
    .rightCol { order: 3; }
    .voteGallery { justify-content:center; }
    canvas{height:260px!important}
    .table-wrapper{display:none}
    #cardsList{display:flex;flex-direction:column}
    .topList .grid2 { grid-template-columns: 1fr; }
    .topList .item img{width:84px;height:84px}
  }

  /* Larger desktop polish */
  @media (min-width: 1400px){
    .wrap{max-width:1400px}
    .topHero { grid-template-columns: 420px 1fr; }
    .topHero .firstImg { width:380px;height:380px; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">A</div>
        <div>
          <h1>Amber Dashboard — Live Voting</h1>
          <div class="subtitle">Top contestants • Live chart • Leaderboard</div>
        </div>
      </div>
      <div class="small muted" style="align-self:center;color:#6b513a">Auto-refresh • CSV-driven</div>
    </header>

    <div class="dashboard">
      <!-- LEFT COLUMN -->
      <div class="leftCol">
        <!-- TOP 1 HERO -->
        <div class="topHero panel" aria-hidden="false">
          <img id="firstImg" class="firstImg" src="" alt="Top contestant">
          <div class="firstInfo">
            <div class="pos" id="firstPos">#1</div>
            <div class="name" id="firstName">Loading…</div>
            <div class="about" id="firstAbout">—</div>
            <div class="score" id="firstScore">0</div>

            <!-- small meta -->
            <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap">
              <button id="rsvpBtn" class="voteBtn" style="background:var(--accent)">Register / Vote</button>
              <button id="learnBtn" class="voteBtn" style="background:transparent;border:2px solid rgba(181,106,0,0.12);color:var(--accent-900)">Learn more</button>
            </div>
          </div>
        </div>

        <!-- PHOTO GALLERY (vote buttons) -->
        <div>
          <h3 style="margin:6px 0 8px 0;font-size:16px;font-family:Merriweather">Contestants — Quick Vote</h3>
          <div id="voteGallery" class="voteGallery" aria-live="polite"></div>
        </div>

        <!-- CHART -->
        <div class="panel">
          <div class="controls">
            <div class="controls-left">
              <div class="muted">Live Chart</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <input id="search" class="search" placeholder="Search contestants…" aria-label="Search contestants" />
              <input id="csvUpload" type="file" accept=".csv" style="display:none" />
              <button id="uploadBtn" class="btn" style="background:var(--accent-700)">Upload CSV (Preview)</button>
            </div>
          </div>
          <canvas id="resultsChart" aria-label="Results chart"></canvas>
        </div>
      </div>

      <!-- RIGHT COLUMN -->
      <aside class="rightCol">
        <div class="topList panel" aria-hidden="false">
          <h4 style="margin:0 0 8px 0;font-family:Merriweather">Top 2–5</h4>
          <div class="grid2" id="topListGrid">
            <!-- items injected here -->
          </div>
        </div>

        <div class="panel table-wrapper" style="margin-top:12px">
          <h4 style="margin:0 0 8px 0;font-family:Merriweather">Leaderboard</h4>
          <table id="resultsTable" aria-live="polite">
            <thead>
              <tr><th style="width:56px">#</th><th>Contestant</th><th style="width:90px">Image</th><th style="width:110px">Votes</th><th>Progress</th></tr>
            </thead>
            <tbody id="resultsBody"><tr><td colspan="5" style="text-align:center;padding:18px">Loading…</td></tr></tbody>
          </table>
        </div>
      </aside>
    </div>

    <!-- MOBILE CARDS (visible on phones instead of table) -->
    <div id="cardsList" aria-hidden="true"></div>

    <footer>© Arewa Tribes & Culture — Mr & Miss Adamawa • AbelTrust</footer>
  </div>

<script>
/* ============================
  Dashboard JS
  - Loads results.csv if present (same folder)
  - Supports local preview upload (CSV)
  - Renders top1, top2-5, gallery with Vote -> WhatsApp
  - Renders Chart.js bar chart
  - Renders leaderboard (desktop) and mobile cards
  - Progress bars animate
============================ */

const CSV_PATH = 'results.csv';
const WA_NUMBER = '2347088947385'; // change to your destination number (country code + number)
const ADMIN_PIN = '4321'; // not used here but kept for compatibility

let csvText = null;
let dataRows = []; // array of {ID,Name,Tribe,Score,Image,About}
let chart = null;
let refreshSeconds = Math.max(5, Number(localStorage.getItem('refreshSeconds') || 10));
let countdownAt = localStorage.getItem('countdownAt') || null;

// --- small CSV parser (handles quotes) ---
function parseCSVText(text){
  if(!text) return [];
  const rows = []; let cur='', row=[], inQ=false;
  for(let i=0;i<text.length;i++){
    const ch=text[i], nxt=text[i+1];
    if(ch === '"'){ if(inQ && nxt === '"'){ cur+='"'; i++; } else { inQ=!inQ; } continue; }
    if(ch === ',' && !inQ){ row.push(cur); cur=''; continue; }
    if((ch === '\n' || ch === '\r') && !inQ){
      if(cur !== '' || row.length>0){ row.push(cur); rows.push(row); row=[]; cur=''; }
      if(ch === '\r' && text[i+1] === '\n') i++;
      continue;
    }
    cur += ch;
  }
  if(cur !== '' || row.length>0){ row.push(cur); rows.push(row); }
  return rows.filter(r=>r.length>0);
}

// --- load CSV from server or fallback to preview/local sample ---
async function loadCSV(){
  // if preview stored in localStorage use that first
  const preview = localStorage.getItem('previewCSV');
  if(preview){ csvText = preview; processCSV(preview); return; }

  try{
    const res = await fetch(CSV_PATH + '?t=' + Date.now());
    if(!res.ok) throw new Error('HTTP ' + res.status);
    const txt = await res.text();
    csvText = txt;
    localStorage.setItem('lastServerCSV', txt);
    processCSV(txt);
  }catch(err){
    const fallback = localStorage.getItem('lastServerCSV');
    if(fallback) { processCSV(fallback); return; }
    // fallback sample data (keeps page working)
    const sample = `ID,Name,Tribe,Score,Image,About
1,"Alice","Bwatiye",250,"https://via.placeholder.com/600x600","Top contestant"
2,"Bob","Fulani",180,"https://via.placeholder.com/600x600","Strong contender"
3,"Chinedu","Kilba",150,"https://via.placeholder.com/600x600","Fashion star"
4,"Diana","Bille",120,"https://via.placeholder.com/600x600","Graceful"
5,"Elias","Marghi",90,"https://via.placeholder.com/600x600","Rising star"
`;
    processCSV(sample);
    console.warn('CSV load failed, using sample data.', err);
  }
}

// --- process csv text to objects ---
function processCSV(txt){
  if(!txt) return;
  const table = parseCSVText(txt.trim());
  if(table.length < 1) return;
  const headers = table[0].map(h=>h.trim());
  const rows = table.slice(1).map((r,i)=>{
    const obj = {};
    headers.forEach((hh,idx)=> obj[hh || ('col'+idx)] = (r[idx] ?? '').trim());
    return {
      ID: obj.ID || String(i+1),
      Name: obj.Name || obj.name || ('Candidate ' + (i+1)),
      Tribe: obj.Tribe || obj.tribe || '',
      Score: Number(String(obj.Score || obj.Votes || 0).replace(/[^0-9.\-]/g,'')) || 0,
      Image: obj.Image || obj.image || '',
      About: obj.About || obj.Description || ''
    };
  });
  rows.sort((a,b)=> b.Score - a.Score);
  dataRows = rows;
  renderAll();
}

// --- render everything ---
function renderAll(){
  renderTop1();
  renderTop2to5();
  renderGallery();
  renderChart();
  renderTable();
  renderCards();
  animateProgressBars();
  // enable/disable upload button if csv present
  document.getElementById('uploadBtn').disabled = false;
}

// Top 1
function renderTop1(){
  const first = dataRows[0] || {Name:'—',Score:0,Image:'',About:''};
  document.getElementById('firstImg').src = first.Image || blankImage();
  document.getElementById('firstName').innerText = first.Name;
  document.getElementById('firstAbout').innerText = first.About || '';
  document.getElementById('firstScore').innerText = first.Score;
}

// Top 2-5
function renderTop2to5(){
  const container = document.getElementById('topListGrid');
  container.innerHTML = '';
  const list = dataRows.slice(1,5);
  list.forEach((r, idx)=>{
    const el = document.createElement('div');
    el.className = 'item';
    el.innerHTML = `<img src="${r.Image || blankImage()}" alt="${escapeHtml(r.Name)}" />
      <div class="meta">
        <div class="rank">#${idx+2}</div>
        <div class="name">${escapeHtml(r.Name)}</div>
        <div class="votes">${r.Score} votes</div>
      </div>`;
    container.appendChild(el);
  });
  // if less than 4, show placeholders
  for(let i=list.length;i<4;i++){
    const placeholder = document.createElement('div');
    placeholder.className='item';
    placeholder.innerHTML = `<img src="${blankImage()}" alt="placeholder" />
      <div class="meta"><div class="rank">#${i+2}</div><div class="name">—</div><div class="votes">0 votes</div></div>`;
    container.appendChild(placeholder);
  }
}

// Vote gallery (above results)
function renderGallery(){
  const gallery = document.getElementById('voteGallery');
  gallery.innerHTML = '';
  (dataRows).forEach((r)=>{
    const card = document.createElement('div');
    card.className = 'voteCard';
    // create whatsapp link encoded
    const wa = `https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(`Hi, I want to vote for\nName: ${r.Name}\nTribe: ${r.Tribe}\nWhat can I do?`)}`;
    card.innerHTML = `<img src="${r.Image || blankImage()}" alt="${escapeHtml(r.Name)}">
      <div class="vname">${escapeHtml(r.Name)}</div>
      <div class="vtribe">${escapeHtml(r.Tribe)}</div>
      <a class="voteBtn" href="${wa}" target="_blank" rel="noopener">Vote on WhatsApp</a>`;
    gallery.appendChild(card);
  });
}

// Chart
function renderChart(){
  const ctx = document.getElementById('resultsChart').getContext('2d');
  const labels = dataRows.map(d=>d.Name);
  const scores = dataRows.map(d=>d.Score);
  const colors = dataRows.map((_,i)=> i===0 ? '#ffcc66' : i===1 ? '#ffd88a' : i===2 ? '#ffdd99' : '#ffb300');

  if(chart){
    chart.data.labels = labels;
    chart.data.datasets[0].data = scores;
    chart.data.datasets[0].backgroundColor = colors;
    chart.update();
    return;
  }

  chart = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label:'Votes', data: scores, backgroundColor: colors }] },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true } },
      maintainAspectRatio: false
    }
  });
}

// Table (desktop)
function renderTable(){
  const tbody = document.getElementById('resultsBody');
  tbody.innerHTML = '';
  const total = Math.max(1, dataRows.reduce((s,r)=> s + (r.Score||0), 0));
  if(dataRows.length === 0){
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:16px">No data</td></tr>';
    return;
  }
  dataRows.forEach((r, idx)=>{
    const pct = Math.round((r.Score / total) * 100);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="font-weight:800">${idx+1}</td>
      <td>
        <div style="font-weight:900">${escapeHtml(r.Name)}</div>
        <div class="about">${escapeHtml(r.About)}</div>
      </td>
      <td><img src="${r.Image || blankImage()}" class="thumb" alt=""></td>
      <td style="font-weight:900">${r.Score}</td>
      <td>
        <div class="progressWrap"><div class="progress" data-percent="${pct}"></div></div>
        <div style="margin-top:6px" class="small">${pct}%</div>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// Mobile cards
function renderCards(){
  const list = document.getElementById('cardsList');
  list.innerHTML = '';
  const total = Math.max(1, dataRows.reduce((s,r)=> s + (r.Score||0), 0));
  dataRows.forEach((r, idx)=>{
    const pct = Math.round((r.Score / total) * 100);
    const div = document.createElement('div');
    div.className = 'cardItem';
    div.innerHTML = `<img src="${r.Image || blankImage()}" alt="">
      <div style="flex:1">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:900">${escapeHtml(r.Name)}</div>
          <div style="font-weight:900;color:var(--accent)">${r.Score}</div>
        </div>
        <div class="small">${escapeHtml(r.Tribe || '')}</div>
        <div class="progressWrap" style="margin-top:8px"><div class="progress" data-percent="${pct}"></div></div>
      </div>`;
    list.appendChild(div);
  });
}

// animate progress bars
function animateProgressBars(){
  setTimeout(()=> {
    document.querySelectorAll('.progress').forEach(el=>{
      const p = Number(el.getAttribute('data-percent') || '0');
      el.style.width = Math.min(100, Math.max(0, p)) + '%';
    });
  }, 60);
}

// helpers
function blankImage(){ return 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='600' height='600'><rect width='100%' height='100%' fill='#fff4e6'/></svg>`); }
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// search filter
document.getElementById('search').addEventListener('input', ()=>{
  const q = document.getElementById('search').value.trim().toLowerCase();
  if(!q){ renderAll(); return; }
  const filtered = dataRows.filter(r => (r.Name||'').toLowerCase().includes(q) || (r.Tribe||'').toLowerCase().includes(q));
  // temporarily render filtered
  const prev = dataRows;
  dataRows = filtered;
  renderAll();
  dataRows = prev;
});

// upload preview
document.getElementById('uploadBtn').addEventListener('click', ()=>{
  document.getElementById('csvUpload').click();
});
document.getElementById('csvUpload').addEventListener('change', (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    const txt = ev.target.result;
    localStorage.setItem('previewCSV', txt);
    csvText = txt;
    processCSV(txt);
    alert('Preview CSV loaded locally.');
  };
  reader.readAsText(f);
});

// auto refresh (do not override while user typed in search)
setInterval(()=> { if(document.activeElement !== document.getElementById('search')) loadCSV(); }, Math.max(5000, refreshSeconds*1000));

// initial load
loadCSV();

// small: refresh countdown display if set
if(countdownAt){
  setInterval(()=>{
    const end = new Date(countdownAt).getTime();
    const diff = end - Date.now();
    if(diff <= 0) return;
    // format in topHero as little subtitle (if you want)
  },1000);
}
</script>
</body>
</html>
