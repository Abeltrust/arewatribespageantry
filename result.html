
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Live Voting Results</title>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3093044450880691"
     crossorigin="anonymous"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="nav.css">
<script src="nav.js" defer></script>

<style>
  :root{
    --bg: #fff7ed;
    --card: #ffffff;
    --muted: #333333;
    --accent: #ffb300; /* amber */
    --accent-600: #ff9800;
    --accent-700: #ef6c00;
    --good: #16a34a;
    --bad: #e02424;
    --glass: rgba(255,255,255,0.6);
    --shadow: 0 10px 30px rgba(15,15,15,0.08);
    --radius: 12px;
  }
  *{box-sizing:border-box}
  body{background:var(--bg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:var(--muted);margin:0;padding:18px;line-height:1.35}
  .wrap{max-width:1100px;margin:0 auto}

  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
  .brand{display:flex;gap:12px;align-items:center}
 .logo {
  width: 56px;
  height: 56px;
  border-radius: 12px;
  background: linear-gradient(135deg, var(--accent), var(--accent-700));
  display: grid;
  place-items: center;
  overflow: hidden; /* ensures image doesn't overflow */
}
.amber-btn {
  display: block;
  width: 100%;
  text-align: center;
  padding: 14px 18px;
  background: #ffb300;            /* amber */
  color: #2b1600;
  font-weight: 800;
  border-radius: 10px;
  text-decoration: none;
  box-shadow: 0 8px 20px rgba(181,106,0,0.14);
  transition: 0.2s ease;
}

.amber-btn:hover {
  background: #ef8d00;
  box-shadow: 0 10px 24px rgba(181,106,0,0.18);
}

.logo img {
  width: 100%;
  height: 100%;
  object-fit: cover; /* fills container while keeping aspect ratio */
  display: block;
}
  h1{margin:0;font-size:18px}
  .subtitle{color:#6b5a4a;font-size:13px}

  /* HERO TOP 5 */
  .hero{display:grid;grid-template-columns:1.45fr 1fr;gap:16px;margin-bottom:18px}
  @media(max-width:900px){ .hero{grid-template-columns:1fr;}}
  .topArea{background:var(--card);padding:16px;border-radius:var(--radius);box-shadow:var(--shadow)}
  .topGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .firstCard{display:flex;gap:12px;padding:14px;border-radius:10px;background:linear-gradient(90deg,rgba(255,179,0,0.12),transparent);align-items:center}
  .firstCard img{width:160px;height:160px;object-fit:cover;border-radius:10px;flex-shrink:0}
  .firstInfo{flex:1}
  .pos{font-size:23px;font-weight:900;color:var(--accent-700)}
  .name{font-size:20px;font-weight:800;margin-top:6px}
  .score{font-size:32px;font-weight:900;color:var(--accent);margin-top:6px}

  .sideCards{display:grid;grid-template-rows:1fr 1fr;gap:12px}
  .medCard{display:flex;gap:10px;align-items:center;padding:12px;border-radius:10px;background:#fff8ea}
  .medCard img{width:72px;height:72px;border-radius:8px;object-fit:cover}

  .bottomCards{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:12px}
  .smallCard{display:flex;gap:10px;align-items:center;padding:10px;border-radius:10px;background:linear-gradient(90deg,rgba(255,235,205,0.6),transparent)}
/* HERO TOP 5 */
/* Desktop-safe image sizing */
.firstCard img {
  width: 160px;
  height: 160px;
  object-fit: cover;
}

.medCard img,
.smallCard img {
  width: 72px;
  height: 72px;
  object-fit: cover;
}
@media (max-width: 900px) {
  .firstCard img {
    width: 100%;
    max-width: 220px;
    height: auto;
  }

  .medCard img,
  .smallCard img {
    width: 64px;
    height: 64px;
  }
}
  /* CHART + controls */
  .panel{background:var(--card);padding:14px;border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:18px}
  .controls{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .controls-left{display:flex;gap:8px;align-items:center}
  .btn{padding:8px 12px;border-radius:8px;background:var(--accent);color:white;border:none;cursor:pointer;font-weight:700}
  .muted{color:#6b6b6b;font-size:13px}

  /* TABLE & CARDS LIST */
  .table-wrapper{overflow-x:auto}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #f0e6d5;text-align:left;vertical-align:middle}
  th{font-size:13px;color:#4b3a2a;background:rgba(0,0,0,0.03)}
  .thumb{width:48px;height:48px;border-radius:8px;object-fit:cover}
  /* .progressWrap{height:10px;background:#fff1de;border-radius:999px;overflow:hidden;margin-top:6px}
  .progress{height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent-700));transition:width .8s ease} */
.progressWrap {
  height: 10px;
  background: #fff1de;
  border-radius: 999px;
  overflow: hidden;
  margin-top: 6px;
}

.progress {
  height: 100%;
  width: 0;
  background: linear-gradient(90deg, var(--accent), var(--accent-700));
  transition: width 0.8s ease;
}
  .amber-btn {
  display: block;
  width: 100%;
  text-align: center;
  padding: 14px 18px;
  background: #ffb300;            /* amber */
  color: #2b1600;
  font-weight: 800;
  border-radius: 10px;
  text-decoration: none;
  box-shadow: 0 8px 20px rgba(181,106,0,0.14);
  transition: 0.2s ease;
}

.amber-btn:hover {
  background: #ef8d00;
  box-shadow: 0 10px 24px rgba(181,106,0,0.18);
}

/* MOBILE RESPONSIVE FIXES */
@media (max-width: 900px) {

  body {
    padding: 12px;
  }

  .wrap {
    padding: 0;
  }

  /* HERO SECTION */
  .hero {
    grid-template-columns: 1fr !important;
    gap: 12px;
  }

  .firstCard {
    flex-direction: column;
    text-align: center;
  }

  .firstCard img {
    width: 100%;
    max-width: 220px;
    height: 220px;
  }

  .name {
    font-size: 18px;
  }

  .score {
    font-size: 26px;
  }

  /* TOP 2 + NEXT 2 CARDS */
  .bottomCards {
    grid-template-columns: 1fr !important;
  }

  .medCard,
  .smallCard {
    width: 100%;
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .medCard img,
  .smallCard img {
    width: 64px;
    height: 64px;
  }

  /* CHART */
  .panel {
    padding: 12px;
  }

  canvas {
    max-height: 280px;
  }

  /* TABLE REMOVED ON MOBILE */
  .table-wrapper {
    display: none !important;
  }
  
  /* MOBILE CARDS */
  #cardsList {
    display: grid !important;
    gap: 10px;
  }

  .cardItem {
    display: flex;
    padding: 12px;
    gap: 12px;
    border-radius: 12px;
  }

  .cardItem img {
    width: 64px;
    height: 64px;
    border-radius: 10px;
    object-fit: cover;
  }

  /* SEARCH FIELD FULL WIDTH */
  #search {
    width: 100% !important;
  }

  header {
    flex-direction: column;
    text-align: center;
  }

  .brand {
    justify-content: center;
  }
}

  /* mobile card list */
  /* #cardsList{display:none;margin-top:12px;gap:8px}
  .cardItem{display:flex;gap:12px;align-items:center;padding:10px;border-radius:10px;background:var(--card);box-shadow:0 6px 18px rgba(0,0,0,0.04)}
  .cardItem img{width:72px;height:72px;object-fit:cover;border-radius:8px} */

  /* responsive */
  /* @media (max-width:900px){
    .table-wrapper{display:none; overflow-x:auto;}
    #cardsList{display:block}
    .bottomCards{grid-template-columns:1fr 1fr}
    .firstCard img{width:120px;height:120px}
    .firstCard{padding:12px}
  } */

  footer{margin-top:20px;text-align:center;color:#7b6d60;font-size:13px}

  /* admin trigger small invisible area */
  #adminTrigger{position:fixed;left:10px;bottom:10px;width:36px;height:36px;opacity:0;z-index:9999}

  /* login overlay */
  #loginOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(10,10,10,0.5);z-index:9999}
  .loginBox{background:var(--card);padding:18px;border-radius:12px;width:320px;box-shadow:var(--shadow)}
  input[type="password"], input[type="datetime-local"]{width:100%;padding:10px;border-radius:8px;border:1px solid #eee;margin-top:8px}

  /* small helpers */
  .small{font-size:13px;color:#5b4a3f}
  .about{font-size:13px;color:#6b5543;margin-top:6px}
</style>
</head>
<body>
  <nav class="mainNav">
    <div class="navBrand">
      <img src="logo.jpg" alt="Arewa Tribes & Culture">
      <span>Arewa Tribes & Culture</span>
    </div>
  
    <button class="navToggle" onclick="toggleMenu()">☰</button>
  
    <ul class="navLinks" id="navLinks">
      <li class="navSection">Valentine Edition</li>
      <li><a href="index.html">Valentine Voting</a></li>
      <li><a href="contestants_result.html">Valentine Results</a></li>
  
      <li class="navDivider"></li>
  
      <li class="navSection">Previous Projects</li>
      <li><a href="result.html">Mr & Mrs Adamawa</a></li>
      <li><a href="culture.html">Culture Showcase</a></li>
    </ul>
  </nav>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo"><img src="logo.jpg" alt="logo"> </div>
      <div>
        <h1>Results — Live Showcase</h1>
        <div class="subtitle">Top contestants, live chart & full leaderboard</div>
      </div>
    </div>
    <!-- <div class="small muted">Auto-refresh from server • Admin-protected</div> -->
  </header>

  <!-- COUNTDOWN -->
  <div id="countdown" class="small muted" style="margin-bottom:12px"></div> 
  <a href="index.html" class="amber-btn"> Back to Home</a>

  <!-- HERO TOP-5 -->
  <div class="hero">
    <div class="topArea">
      <div class="firstCard" id="firstCard">
        <img src="" alt="First" id="firstImg">
        <div class="firstInfo">
          <div class="pos" id="firstPos">#1</div>
          <div class="name" id="firstName">Loading...</div>
          <div class="about" id="firstAbout">—</div>
          <div class="score" id="firstScore">0</div>
        </div>
      </div>

      <div class="bottomCards">
        <div class="smallCard medCard" id="secondCard">
          <img src="" id="secondImg" alt="2nd">
          <div>
            <div style="font-weight:800" id="secondName">—</div>
            <div class="small" id="secondScore">0 votes</div>
          </div>
        </div>

        <div class="smallCard medCard" id="thirdCard">
          <img src="" id="thirdImg" alt="3rd">
          <div>
            <div style="font-weight:800" id="thirdName">—</div>
            <div class="small" id="thirdScore">0 votes</div>
          </div>
        </div>

        <div class="smallCard" id="fourthCard" style="margin-top:6px">
          <img src="" id="fourthImg" alt="4th">
          <div>
            <div style="font-weight:800" id="fourthName">—</div>
            <div class="small" id="fourthScore">0 votes</div>
          </div>
        </div>

        <div class="smallCard" id="fifthCard" style="margin-top:6px">
          <img src="" id="fifthImg" alt="5th">
          <div>
            <div style="font-weight:800" id="fifthName">—</div>
            <div class="small" id="fifthScore">0 votes</div>
          </div>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="controls">
        <div class="controls-left">
          <div class="muted">Live Chart</div>
        </div>
        <div>
          <!-- <button class="btn" id="downloadCSVBtn">Prepare CSV for Download</button> -->
        </div>
      </div>

      <canvas id="resultsChart" aria-label="Results chart"></canvas>
    </div>
  </div>

  <!-- SEARCH -->
  <div style="display:flex;justify-content:flex-end;margin-bottom:8px;gap:8px;align-items:center">
    <input id="search" placeholder="Search contestants..." style="padding:8px;border-radius:8px;border:1px solid #e9dcc9;width:260px" />
  </div>

  <!-- LEADERBOARD -->
  <div class="panel table-wrapper">
    <table id="resultsTable" aria-live="polite">
      <thead>
        <tr><th style="width:64px">#</th><th>Contestant</th><th style="width:78px">Image</th><th style="width:110px">Votes</th><th style="width:220px">Progress</th></tr>
      </thead>
      <tbody id="resultsBody"><tr><td colspan="5" style="text-align:center;padding:16px">Loading...</td></tr></tbody>
    </table>
  </div>

  <!-- MOBILE CARDS -->
  <div id="cardsList"></div>

  <!-- ADMIN TRIGGER (invisible square) -->
  <div id="adminTrigger" title="Admin"></div>

  <!-- LOGIN OVERLAY -->
  <div id="loginOverlay">
    <div class="loginBox">
      <h3 style="margin:0 0 8px 0;color:var(--accent)">Admin Login</h3>
      <div class="small muted">Enter PIN to unlock admin controls</div>
      <input id="adminPin" type="password" placeholder="Admin PIN" />
      <div style="display:flex;gap:8px;margin-top:10px;justify-content:flex-end">
        <button class="btn" id="loginBtn">Unlock</button>
      </div>
      <div id="loginMsg" class="small" style="margin-top:8px;color:var(--bad);display:none"></div>
    </div>
  </div>

  <!-- ADMIN PANEL (appears after unlock) -->
  <div id="adminPanel" class="panel" style="display:none;margin-top:12px">
    <h3 style="margin:0 0 12px 0">Admin Control</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <label class="small">Upload CSV (preview only)</label>
      <input id="csvUpload" type="file" accept=".csv" />
      <button class="btn" id="uploadBtn" style="background:var(--accent)">Upload & Preview</button>

      <label class="small" style="margin-left:8px">Countdown</label>
      <input id="closeAt" type="datetime-local" />

      <button class="btn" id="setClose" style="background:var(--accent-700)">Set Close</button>
      <button class="btn" id="logoutBtn" style="background:#b55200">Logout</button>
      <button class="btn" id="clearPreview" style="background:#9e9e9e">Clear Preview</button>
    </div>
    <div class="small" style="margin-top:10px;color:#6b5543">To persist changes live, replace the server <code>results.csv</code> with the downloaded CSV (use Prepare CSV for Download button).</div>
  </div>
  <a href="https://www.facebook.com/share/17eKcrqs3x/" target="_blank" class="amber-btn">Follow Us On Facebook</a>
  <footer>Made with culture • AbelTrust</footer>
</div>

<script>
/* ==================================================
   CONFIG & STATE
   ================================================== */
const CSV_PATH = 'results.csv';
const ADMIN_PIN_DEFAULT = '4321';
let ADMIN_PIN = ADMIN_PIN_DEFAULT;
let isAuthed = false;
let csvTextCache = null;
let dataRows = [];
let chart = null;
let countdownAt = localStorage.getItem('countdownAt') || null;
let refreshSeconds = Number(localStorage.getItem('refreshSeconds') || 10);
let tries = Number(localStorage.getItem('tries') || 0);
let lockUntil = Number(localStorage.getItem('lockUntil') || 0);

/* =============== UTIL: CSV parser =============== */
function parseCSVText(text){
  if(!text) return [];
  const rows = [];
  let cur = '', row = [], inQuotes=false;
  for(let i=0;i<text.length;i++){
    const ch = text[i], nxt = text[i+1];
    if(ch === '"'){
      if(inQuotes && nxt === '"'){ cur += '"'; i++; continue; }
      inQuotes = !inQuotes;
      continue;
    }
    if(ch === ',' && !inQuotes){ row.push(cur); cur=''; continue; }
    if((ch === '\n' || ch === '\r') && !inQuotes){
      if(cur !== '' || row.length>0){ row.push(cur); rows.push(row); row=[]; cur=''; }
      if(ch === '\r' && text[i+1] === '\n'){ i++; }
      continue;
    }
    cur += ch;
  }
  if(cur !== '' || row.length>0){ row.push(cur); rows.push(row); }
  return rows.filter(r=>r.length>0);
}

/* =============== LOAD CSV from server =============== */
async function loadCSVFromServer(){
  if(document.activeElement === document.getElementById('search')) return; // skip refresh while typing
  try{
    const res = await fetch(CSV_PATH + '?t=' + Date.now());
    if(!res.ok) throw new Error('HTTP ' + res.status);
    const txt = await res.text();
    csvTextCache = txt;
    localStorage.setItem('lastServerCSV', txt);
    processCSV(txt);
  }catch(err){
    const fallback = localStorage.getItem('previewCSV') || localStorage.getItem('lastServerCSV');
    if(fallback) processCSV(fallback);
    else {
      document.getElementById('resultsBody').innerHTML = '<tr><td colspan="5" style="text-align:center;padding:16px">Unable to load CSV — ensure results.csv is on server.</td></tr>';
    }
    console.error('CSV load failed', err);
  }
}

/* =============== PROCESS CSV =============== */
function processCSV(txt){
  if(!txt){ return; }
  const table = parseCSVText(String(txt).trim());
  if(table.length < 1) return;
  const headers = table[0].map(h => h.trim());
  const rows = table.slice(1).map((r,i)=>{
    const obj = {};
    headers.forEach((hh, idx)=> obj[hh || ('col'+idx)] = (r[idx] ?? '').trim());
    return {
      ID: obj.Contestant || String(i+1),
      Name: obj.Name || obj.name || obj.FullName || ('Candidate ' + (i+1)),
      Score: Number(String(obj.Score || obj.Votes || 0).replace(/[^0-9.\-]/g,'')) || 0,
      Image: obj.Image || obj.image || obj.Photo || '',
      About: obj.Tribe || obj.Description || ''
    };
  });

  rows.sort((a,b)=> b.Score - a.Score);
  dataRows = rows;
  renderAll();
}

/* =============== RENDER ALL =============== */
function renderAll(){
  renderTop5();
  renderTable();
  renderCards();
  renderChart();
  
  // Ensure progress bars are updated AFTER DOM paint
  setTimeout(() => {
    const maxScore = Math.max(...dataRows.map(r => r.Score), 1);
    document.querySelectorAll('tr').forEach(tr => {
      const tdScore = tr.querySelector('td:nth-child(4)');
      const progressEl = tr.querySelector('.progress');
      if(progressEl && tdScore){
        const score = Number(tdScore.innerText) || 0;
        progressEl.style.width = ((score / maxScore) * 100) + '%';
      }
    });
  }, 50);
}


function renderTop5(){
  const top = dataRows.slice(0,5);
  const first = top[0] || {Name:'—',Score:0,Image:'',About:'', ID:''};
  document.getElementById('firstImg').src = first.Image || blankImage();
  document.getElementById('firstPos').innerText = 'Contestant:'+first.ID;
  document.getElementById('firstName').innerText = first.Name;
  document.getElementById('firstAbout').innerText = first.About || '';
  document.getElementById('firstScore').innerText = first.Score;

  const s2 = top[1] || {Name:'—',Score:0,Image:''};
  document.getElementById('secondImg').src = s2.Image || blankImage();
  document.getElementById('secondName').innerText = s2.Name;
  document.getElementById('secondScore').innerText = s2.Score + ' votes';

  const s3 = top[2] || {Name:'—',Score:0,Image:''};
  document.getElementById('thirdImg').src = s3.Image || blankImage();
  document.getElementById('thirdName').innerText = s3.Name;
  document.getElementById('thirdScore').innerText = s3.Score + ' votes';

  const s4 = top[3] || {Name:'—',Score:0,Image:''};
  document.getElementById('fourthImg').src = s4.Image || blankImage();
  document.getElementById('fourthName').innerText = s4.Name;
  document.getElementById('fourthScore').innerText = s4.Score + ' votes';

  const s5 = top[4] || {Name:'—',Score:0,Image:''};
  document.getElementById('fifthImg').src = s5.Image || blankImage();
  document.getElementById('fifthName').innerText = s5.Name;
  document.getElementById('fifthScore').innerText = s5.Score + ' votes';
}

function renderTable(){
  const tbody = document.getElementById('resultsBody');
  const searchTerm = (document.getElementById('search')?.value || '').toLowerCase();
  if(dataRows.length<1){ tbody.innerHTML='<tr><td colspan="5" style="text-align:center;padding:16px">No data</td></tr>'; return; }
  tbody.innerHTML = '';
  const maxScore = Math.max(...dataRows.map(r=>r.Score),1);
  dataRows.forEach((r,i)=>{
    if(searchTerm && !r.Name.toLowerCase().includes(searchTerm)) return;
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${i+1}</td>
      <td>${r.Name}</td>
      <td><img class="thumb" src="${r.Image||blankImage()}" /></td>
      <td>${r.Score}</td>
      <td><div class="progressWrap"><div class="progress" data-percent="${(r.Score/maxScore)*100}"></div></div></td>
    `;
    tbody.appendChild(row);
  });
}

function renderCards(){
  const container = document.getElementById('cardsList');
  container.innerHTML = '';
  const searchTerm = (document.getElementById('search')?.value || '').toLowerCase();
  const maxScore = Math.max(...dataRows.map(r=>r.Score),1);
  dataRows.forEach((r,i)=>{
    if(searchTerm && !r.Name.toLowerCase().includes(searchTerm)) return;
    const div = document.createElement('div');
    div.className='cardItem';
    div.innerHTML=`<img src="${r.Image||blankImage()}" alt=""><div><div style="font-weight:800">${r.Name}</div><div class="small">${r.Score} votes</div></div>`;
    container.appendChild(div);
  });
}

function renderChart(){
  const ctx = document.getElementById('resultsChart').getContext('2d');
  const labels = dataRows.map(r=>r.Name);
  const scores = dataRows.map(r=>r.Score);
  const colors = dataRows.map((_,i)=> i===0?'#ffcc66': i===1?'#ffd88a': i===2?'#ffe0b3':'#ffb300');
  if(chart){ chart.data.labels=labels; chart.data.datasets[0].data=scores; chart.data.datasets[0].backgroundColor=colors; chart.update(); return; }
  chart = new Chart(ctx,{
    type:'bar',
    data:{labels,datasets:[{label:'Votes',data:scores,backgroundColor:colors}]},
    options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
  });
}

function blankImage(){return 'data:image/svg+xml;base64,'+btoa('<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80"><rect width="80" height="80" fill="#f0e6d5"/></svg>');}

/* =============== SEARCH FILTER =============== */
document.getElementById('search')?.addEventListener('input',()=>{
  renderTable();
  renderCards();
});

/* =============== COUNTDOWN =============== */
function updateCountdown() {
  const el = document.getElementById('countdown');
  const countdownAt = new Date("December 7, 2025 16:30:00").getTime();

  if (!countdownAt) {
    el.innerText = 'No active countdown';
    return;
  }

  const end = countdownAt;
  const now = Date.now();
  const diff = end - now;

  if (diff <= 0) {
    el.innerText = 'Voting ended';
    return;
  }

  const d = Math.floor(diff / 86400000);
  const h = Math.floor((diff % 86400000) / 3600000);
  const m = Math.floor((diff % 3600000) / 60000);
  const s = Math.floor((diff % 60000) / 1000);

  el.innerText = `Ends in: ${d}d ${h}h ${m}m ${s}s`;
}
setInterval(updateCountdown, 1000);
updateCountdown();

/* =============== AUTO REFRESH =============== */
setInterval(loadCSVFromServer, refreshSeconds*1000);

/* =============== INITIAL LOAD =============== */
loadCSVFromServer();
</script>
</body>
</html>
